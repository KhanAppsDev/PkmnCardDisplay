<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pok√©Frame ‚Äî Send to Display</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">

<style>
  :root {
    --bg: #0a0a0f;
    --surface: #13131a;
    --surface2: #1c1c28;
    --border: #2a2a3d;
    --accent: #ffcb05;
    --accent2: #3b5bdb;
    --text: #f0f0f5;
    --muted: #6b6b8a;
    --success: #40c057;
    --error: #fa5252;
    --radius: 12px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 24px 16px 48px;
    background-image:
      radial-gradient(ellipse 80% 40% at 50% -10%, rgba(59,91,219,0.18) 0%, transparent 70%),
      url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.015'%3E%3Crect x='0' y='0' width='1' height='1'/%3E%3Crect x='20' y='20' width='1' height='1'/%3E%3C/g%3E%3C/svg%3E");
  }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  header {
    text-align: center;
    margin-bottom: 36px;
    animation: fadeDown 0.6s ease both;
  }

  .logo {
    font-family: 'Press Start 2P', monospace;
    font-size: clamp(16px, 5vw, 22px);
    color: var(--accent);
    text-shadow: 0 0 30px rgba(255,203,5,0.4), 3px 3px 0 rgba(0,0,0,0.5);
    letter-spacing: 1px;
    line-height: 1.4;
  }

  .tagline {
    margin-top: 10px;
    color: var(--muted);
    font-size: 13px;
    font-weight: 300;
    letter-spacing: 0.5px;
  }

  /* ‚îÄ‚îÄ Card ‚îÄ‚îÄ */
  .card {
    width: 100%;
    max-width: 420px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 28px 24px;
    animation: fadeUp 0.5s ease both;
    animation-delay: 0.1s;
  }

  /* ‚îÄ‚îÄ Steps ‚îÄ‚îÄ */
  .step {
    margin-bottom: 24px;
  }

  .step-label {
    font-family: 'Press Start 2P', monospace;
    font-size: 8px;
    color: var(--muted);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .step-num {
    width: 20px; height: 20px;
    border-radius: 50%;
    background: var(--accent2);
    color: #fff;
    font-size: 7px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }

  /* ‚îÄ‚îÄ Search input ‚îÄ‚îÄ */
  .search-wrap {
    position: relative;
  }

  .search-wrap input {
    width: 100%;
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    padding: 13px 16px 13px 42px;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    appearance: none;
  }

  .search-wrap input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(255,203,5,0.12);
  }

  .search-icon {
    position: absolute;
    left: 14px; top: 50%;
    transform: translateY(-50%);
    color: var(--muted);
    pointer-events: none;
    font-size: 16px;
  }

  /* ‚îÄ‚îÄ Dropdown ‚îÄ‚îÄ */
  select {
    width: 100%;
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    padding: 13px 16px;
    outline: none;
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 7L11 1' stroke='%236b6b8a' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 16px center;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  select:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(255,203,5,0.12);
  }

  select:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  select option {
    background: var(--surface2);
    color: var(--text);
  }

  /* ‚îÄ‚îÄ Autocomplete dropdown ‚îÄ‚îÄ */
  .autocomplete-list {
    position: absolute;
    top: calc(100% + 4px);
    left: 0; right: 0;
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    max-height: 220px;
    overflow-y: auto;
    z-index: 100;
    display: none;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }

  .autocomplete-list.open { display: block; }

  .autocomplete-item {
    padding: 11px 16px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: background 0.12s;
    border-bottom: 1px solid rgba(255,255,255,0.04);
  }

  .autocomplete-item:last-child { border-bottom: none; }
  .autocomplete-item:hover, .autocomplete-item.active {
    background: rgba(255,203,5,0.08);
    color: var(--accent);
  }

  .poke-sprite {
    width: 28px; height: 28px;
    image-rendering: pixelated;
    flex-shrink: 0;
  }

  /* ‚îÄ‚îÄ Card preview ‚îÄ‚îÄ */
  .card-preview-wrap {
    margin-top: 8px;
    background: var(--surface2);
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    display: flex;
    align-items: center;
    gap: 14px;
    min-height: 80px;
    transition: border-color 0.2s;
  }

  .card-preview-wrap.has-card {
    border-color: rgba(255,203,5,0.3);
  }

  .card-thumb {
    width: 56px;
    height: 80px;
    object-fit: contain;
    border-radius: 6px;
    image-rendering: auto;
    flex-shrink: 0;
    background: rgba(0,0,0,0.2);
  }

  .card-thumb-placeholder {
    width: 56px; height: 80px;
    border-radius: 6px;
    background: var(--border);
    display: flex; align-items: center; justify-content: center;
    color: var(--muted);
    font-size: 22px;
    flex-shrink: 0;
  }

  .card-info { flex: 1; min-width: 0; }
  .card-name { font-size: 13px; font-weight: 500; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .card-set { font-size: 11px; color: var(--muted); }
  .card-number { font-size: 10px; color: var(--muted); margin-top: 2px; font-family: 'Press Start 2P', monospace; }

  /* ‚îÄ‚îÄ Push button ‚îÄ‚îÄ */
  .push-btn {
    width: 100%;
    margin-top: 8px;
    padding: 16px;
    background: var(--accent);
    color: #0a0a0f;
    border: none;
    border-radius: var(--radius);
    font-family: 'Press Start 2P', monospace;
    font-size: 10px;
    cursor: pointer;
    letter-spacing: 1px;
    position: relative;
    overflow: hidden;
    transition: transform 0.1s, box-shadow 0.2s, opacity 0.2s;
    box-shadow: 0 4px 20px rgba(255,203,5,0.25);
  }

  .push-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 28px rgba(255,203,5,0.35);
  }

  .push-btn:active:not(:disabled) { transform: translateY(0); }

  .push-btn:disabled {
    opacity: 0.35;
    cursor: not-allowed;
    box-shadow: none;
  }

  .push-btn .btn-ripple {
    position: absolute;
    border-radius: 50%;
    background: rgba(255,255,255,0.35);
    transform: scale(0);
    animation: ripple 0.5s ease-out;
    pointer-events: none;
  }

  /* ‚îÄ‚îÄ Status toast ‚îÄ‚îÄ */
  .status {
    margin-top: 16px;
    padding: 12px 16px;
    border-radius: var(--radius);
    font-size: 13px;
    display: none;
    align-items: center;
    gap: 10px;
    animation: fadeUp 0.3s ease;
  }

  .status.show { display: flex; }
  .status.success { background: rgba(64,192,87,0.12); border: 1px solid rgba(64,192,87,0.3); color: var(--success); }
  .status.error   { background: rgba(250,82,82,0.12);  border: 1px solid rgba(250,82,82,0.3);  color: var(--error);   }
  .status.loading { background: rgba(255,203,5,0.08);  border: 1px solid rgba(255,203,5,0.2);  color: var(--accent);  }

  .spinner {
    width: 16px; height: 16px;
    border: 2px solid rgba(255,203,5,0.2);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    flex-shrink: 0;
  }

  /* ‚îÄ‚îÄ Config section ‚îÄ‚îÄ */
  .config-toggle {
    margin-top: 20px;
    text-align: center;
    cursor: pointer;
    font-size: 11px;
    color: var(--muted);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: color 0.2s;
    user-select: none;
  }
  .config-toggle:hover { color: var(--text); }

  .config-panel {
    margin-top: 16px;
    padding: 18px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    display: none;
  }
  .config-panel.open { display: block; }

  .config-field { margin-bottom: 14px; }
  .config-field:last-child { margin-bottom: 0; }

  .config-label {
    font-size: 11px;
    color: var(--muted);
    margin-bottom: 6px;
    display: block;
    font-family: 'Press Start 2P', monospace;
    font-size: 7px;
    letter-spacing: 0.5px;
  }

  .config-field input {
    width: 100%;
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: monospace;
    font-size: 12px;
    padding: 10px 12px;
    outline: none;
    transition: border-color 0.2s;
  }
  .config-field input:focus { border-color: var(--accent); }

  .save-config-btn {
    width: 100%;
    padding: 10px;
    background: var(--accent2);
    color: #fff;
    border: none;
    border-radius: 8px;
    font-family: 'Press Start 2P', monospace;
    font-size: 8px;
    cursor: pointer;
    letter-spacing: 0.5px;
    margin-top: 14px;
    transition: opacity 0.2s;
  }
  .save-config-btn:hover { opacity: 0.85; }

  /* ‚îÄ‚îÄ Animations ‚îÄ‚îÄ */
  @keyframes fadeDown {
    from { opacity: 0; transform: translateY(-16px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  @keyframes ripple {
    to { transform: scale(4); opacity: 0; }
  }
  @keyframes pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(255,203,5,0.4); }
    50%       { box-shadow: 0 0 0 10px rgba(255,203,5,0); }
  }

  .push-btn.sending { animation: pulse 1s infinite; }

  /* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
  footer {
    margin-top: 32px;
    font-size: 11px;
    color: var(--muted);
    text-align: center;
    line-height: 1.7;
  }

  footer a { color: var(--muted); }
</style>
</head>
<body>

<header>
  <div class="logo">Pok√©Frame</div>
  <p class="tagline">Send a card to your Raspberry Pi display</p>
</header>

<div class="card">

  <!-- Step 1: Pokemon search -->
  <div class="step" id="step1">
    <div class="step-label"><span class="step-num">1</span> Choose a Pok√©mon</div>
    <div class="search-wrap">
      <span class="search-icon">‚åï</span>
      <input type="text" id="pokeSearch" placeholder="Search Pok√©mon..." autocomplete="off" spellcheck="false">
      <div class="autocomplete-list" id="autoList"></div>
    </div>
  </div>

  <!-- Step 2: Card selector -->
  <div class="step" id="step2">
    <div class="step-label"><span class="step-num">2</span> Choose a card</div>
    <select id="cardSelect" disabled>
      <option value="">‚Äî search a Pok√©mon first ‚Äî</option>
    </select>
    <div class="card-preview-wrap" id="cardPreview">
      <div class="card-thumb-placeholder">üÉè</div>
      <div class="card-info">
        <div class="card-name" style="color:var(--muted)">No card selected</div>
        <div class="card-set">Select a Pok√©mon and card above</div>
      </div>
    </div>
  </div>

  <!-- Push -->
  <div class="step">
    <div class="step-label"><span class="step-num">3</span> Send to display</div>
    <button class="push-btn" id="pushBtn" disabled>‚ñ∂ PUSH TO DISPLAY</button>
    <div class="status" id="statusMsg"></div>
  </div>

  <!-- Config toggle -->
  <div class="config-toggle" id="configToggle">‚öô Firebase config <span id="configArrow">‚ñæ</span></div>
  <div class="config-panel" id="configPanel">
    <div class="config-field">
      <label class="config-label">Firebase Project ID</label>
      <input type="text" id="cfgProjectId" placeholder="your-project-id">
    </div>
    <div class="config-field">
      <label class="config-label">Firestore API Key</label>
      <input type="text" id="cfgApiKey" placeholder="AIzaSy...">
    </div>
    <button class="save-config-btn" id="saveConfigBtn">üíæ SAVE CONFIG</button>
  </div>

</div>

<footer>
  Uses <a href="https://pokemontcg.io" target="_blank">Pok√©mon TCG API</a> &amp; Firebase Firestore<br>
  Data updates instantly on your Pi display ‚ö°
</footer>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp }        from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  FIREBASE CONFIG  (your real credentials)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FIREBASE_CONFIG = {
  apiKey:            "AIzaSyCrn8gIBWdM3OuLuxVzn-oMLDc4iCXbJ9w",
  authDomain:        "pkmncarddisplay.firebaseapp.com",
  projectId:         "pkmncarddisplay",
  storageBucket:     "pkmncarddisplay.firebasestorage.app",
  messagingSenderId: "49396278277",
  appId:             "1:49396278277:web:6767d7e85fd33a8c5e286c"
};

// Init Firebase once at page load
const firebaseApp = initializeApp(FIREBASE_CONFIG);
const db          = getFirestore(firebaseApp);

// Hide config panel ‚Äî credentials are already baked in
document.getElementById('configToggle').style.display = 'none';
document.getElementById('configPanel').style.display  = 'none';

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  POKEMON SEARCH  (PokeAPI for names/sprites)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let allPokemon      = [];
let selectedPokemon = null;
let selectedCard    = null;
let allCards        = [];

async function loadPokemonList() {
  try {
    const r = await fetch('https://pokeapi.co/api/v2/pokemon?limit=1025');
    const d = await r.json();
    allPokemon = d.results.map(p => p.name);
  } catch(e) {
    console.warn('PokeAPI list failed, using built-in fallback list');
    // Fallback: common Pok√©mon so the search still works offline
    allPokemon = [
      'bulbasaur','ivysaur','venusaur','charmander','charmeleon','charizard',
      'squirtle','wartortle','blastoise','pikachu','raichu','eevee','vaporeon',
      'jolteon','flareon','espeon','umbreon','leafeon','glaceon','sylveon',
      'mewtwo','mew','gengar','snorlax','dragonite','tyranitar','lucario',
      'garchomp','greninja','mimikyu','dragapult','ogerpon','terapagos',
      'rayquaza','lugia','ho-oh','celebi','kyogre','groudon','deoxys',
      'dialga','palkia','giratina','arceus','zekrom','reshiram','xerneas',
      'yveltal','zygarde','solgaleo','lunala','necrozma','zacian','zamazenta',
      'calyrex','koraidon','miraidon','mewtwo','alakazam','machamp','golem',
      'arcanine','slowbro','haunter','electabuzz','magmar','jynx','lapras',
      'ditto','porygon','articuno','zapdos','moltres','togekiss','umbreon',
    ];
  }
}

loadPokemonList();

const searchInput = document.getElementById('pokeSearch');
const autoList    = document.getElementById('autoList');

function spriteUrl(name) {
  return `https://img.pokemondb.net/sprites/sword-shield/icon/${name}.png`;
}

let activeIdx = -1;

searchInput.addEventListener('input', () => {
  const q = searchInput.value.trim().toLowerCase();
  activeIdx = -1;
  if (!q) { autoList.classList.remove('open'); return; }
  const matches = allPokemon
    .filter(n => n.includes(q))
    .sort((a, b) => (a.startsWith(q) ? -1 : b.startsWith(q) ? 1 : 0))
    .slice(0, 20);
  if (!matches.length) { autoList.classList.remove('open'); return; }
  autoList.innerHTML = matches.map(name =>
    `<div class="autocomplete-item" data-name="${name}">
       <img class="poke-sprite" src="${spriteUrl(name)}" onerror="this.style.display='none'" alt="">
       <span>${capitalize(name)}</span>
     </div>`
  ).join('');
  autoList.classList.add('open');
});

autoList.addEventListener('click', e => {
  const item = e.target.closest('.autocomplete-item');
  if (!item) return;
  selectPokemon(item.dataset.name);
});

searchInput.addEventListener('keydown', e => {
  const items = autoList.querySelectorAll('.autocomplete-item');
  if (e.key === 'ArrowDown') { activeIdx = Math.min(activeIdx+1, items.length-1); highlightItem(items); e.preventDefault(); }
  if (e.key === 'ArrowUp')   { activeIdx = Math.max(activeIdx-1, 0);              highlightItem(items); e.preventDefault(); }
  if (e.key === 'Enter' && activeIdx >= 0) items[activeIdx].click();
  if (e.key === 'Escape') autoList.classList.remove('open');
});

function highlightItem(items) {
  items.forEach((el, i) => el.classList.toggle('active', i === activeIdx));
  if (activeIdx >= 0) items[activeIdx].scrollIntoView({ block: 'nearest' });
}

document.addEventListener('click', e => {
  if (!e.target.closest('.search-wrap')) autoList.classList.remove('open');
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  CARD FETCHING  ‚Äî 3-tier fallback system
//
//  Tier 1: pokemontcg.io  (best data, may rate-limit without key)
//  Tier 2: tcgdex.net     (European mirror, no key needed)
//  Tier 3: Built-in stub  (always works ‚Äî shows image via TCGdex CDN)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function fetchCardsTier1(name) {
  // pokemontcg.io ‚Äî exact name match, returns rich data
  const url = `https://api.pokemontcg.io/v2/cards?q=name:"${encodeURIComponent(name)}"&pageSize=250&select=id,name,number,set,images`;
  const r = await fetch(url, { headers: { 'Accept': 'application/json' } });
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  const d = await r.json();
  const cards = d.data || [];
  if (!cards.length) throw new Error('No cards returned');
  return cards.map(c => ({
    id:       c.id,
    name:     c.name,
    number:   c.number,
    setName:  c.set?.name  || '?',
    setId:    c.set?.id    || '',
    imageUrl: c.images?.large || c.images?.small || '',
    imageSmall: c.images?.small || '',
    source:   'tier1',
  })).sort((a,b) => a.setName.localeCompare(b.setName));
}

async function fetchCardsTier2(name) {
  // tcgdex.net ‚Äî free, CORS-friendly, good coverage
  // Search endpoint returns array of card stubs; we enrich with set info
  const searchName = name.toLowerCase().replace(/-/g, ' ');
  const url = `https://api.tcgdex.net/v2/en/cards?name=${encodeURIComponent(searchName)}`;
  const r = await fetch(url);
  if (!r.ok) throw new Error(`TCGdex HTTP ${r.status}`);
  const cards = await r.json();
  if (!Array.isArray(cards) || !cards.length) throw new Error('No cards');
  return cards.map(c => {
    const imgBase = c.image
      ? `${c.image}/high.webp`
      : `https://assets.tcgdex.net/en/${c.set?.id || 'unknown'}/${c.localId || c.id}/high.webp`;
    return {
      id:         `tcgdex-${c.id}`,
      name:       c.name || name,
      number:     c.localId || c.id,
      setName:    c.set?.name || c.set?.id || 'Unknown Set',
      setId:      c.set?.id || '',
      imageUrl:   imgBase,
      imageSmall: imgBase,
      source:     'tier2',
    };
  }).sort((a,b) => a.setName.localeCompare(b.setName));
}

function buildFallbackCards(name) {
  // Tier 3: We know the TCGdex URL pattern so we can synthesise
  // a handful of real cards for the most popular Pok√©mon.
  // This is a last resort that always gives *something* to push.
  const capitalized = capitalize(name);
  // Map of pok√©mon ‚Üí [{ set, setName, num }]
  const KNOWN = {
    pikachu:    [{set:'base1',setName:'Base Set',num:'58'},{set:'swsh1',setName:'Sword & Shield',num:'057'},{set:'sv1',setName:'Scarlet & Violet',num:'081'}],
    charizard:  [{set:'base1',setName:'Base Set',num:'4'},{set:'swsh35',setName:'Champion\'s Path',num:'074'},{set:'sv3pt5',setName:'151',num:'006'}],
    mewtwo:     [{set:'base1',setName:'Base Set',num:'10'},{set:'sv3pt5',setName:'151',num:'150'},{set:'swsh9',setName:'Brilliant Stars',num:'057'}],
    eevee:      [{set:'base1',setName:'Base Set',num:'51'},{set:'sm35',setName:'McDonald\'s 2018',num:'5'},{set:'sv1',setName:'Scarlet & Violet',num:'129'}],
    gengar:     [{set:'base1',setName:'Base Set',num:'5'},{set:'sv3pt5',setName:'151',num:'094'}],
    lucario:    [{set:'dp2',setName:'Mysterious Treasures',num:'12'},{set:'swsh10',setName:'Astral Radiance',num:'079'}],
    greninja:   [{set:'xy6',setName:'Breakthrough',num:'41'},{set:'sm115',setName:'Hidden Fates',num:'SV61'}],
    rayquaza:   [{set:'ex7',setName:'Team Magma vs Team Aqua',num:'97'},{set:'swsh7',setName:'Evolving Skies',num:'110'}],
    ogerpon:    [{set:'sv5',setName:'Temporal Forces',num:'016'},{set:'sv8pt5',setName:'Prismatic Evolutions',num:'012'}],
  };
  const known = KNOWN[name.toLowerCase()];
  if (known) {
    return known.map(k => ({
      id:         `stub-${k.set}-${k.num}`,
      name:       capitalized,
      number:     k.num,
      setName:    k.setName,
      setId:      k.set,
      imageUrl:   `https://assets.tcgdex.net/en/${k.set}/${k.num}/high.webp`,
      imageSmall: `https://assets.tcgdex.net/en/${k.set}/${k.num}/high.webp`,
      source:     'tier3',
    }));
  }
  // Ultimate fallback: one generic entry pointing at TCGdex search page
  return [{
    id:         `stub-${name}-001`,
    name:       capitalized,
    number:     '?',
    setName:    'API unavailable ‚Äî try again',
    setId:      '',
    imageUrl:   '',
    imageSmall: '',
    source:     'tier3-empty',
  }];
}

async function fetchCardsWithFallback(name) {
  // Try Tier 1
  try {
    const cards = await fetchCardsTier1(name);
    console.log(`[Tier 1] Got ${cards.length} cards for ${name}`);
    return { cards, tier: 1 };
  } catch(e) {
    console.warn('[Tier 1] Failed:', e.message);
  }
  // Try Tier 2
  try {
    const cards = await fetchCardsTier2(name);
    console.log(`[Tier 2] Got ${cards.length} cards for ${name}`);
    return { cards, tier: 2 };
  } catch(e) {
    console.warn('[Tier 2] Failed:', e.message);
  }
  // Tier 3 always works
  const cards = buildFallbackCards(name);
  console.log(`[Tier 3] Using ${cards.length} stub card(s) for ${name}`);
  return { cards, tier: 3 };
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  SELECT POKEMON ‚Üí load cards
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function selectPokemon(name) {
  selectedPokemon = name;
  selectedCard    = null;
  searchInput.value = capitalize(name);
  autoList.classList.remove('open');

  const cardSelect = document.getElementById('cardSelect');
  cardSelect.disabled = true;
  cardSelect.innerHTML = '<option>Loading cards‚Ä¶</option>';
  resetPreview();
  document.getElementById('pushBtn').disabled = true;
  showStatus('Fetching cards‚Ä¶', 'loading', true);

  const { cards, tier } = await fetchCardsWithFallback(name);
  allCards = cards;

  if (!allCards.length || (allCards.length === 1 && allCards[0].source === 'tier3-empty')) {
    cardSelect.innerHTML = '<option value="">No cards found ‚Äî API may be down</option>';
    showStatus('‚ö† No cards found. Try a different Pok√©mon or try again later.', 'error');
    return;
  }

  cardSelect.innerHTML = '<option value="">‚Äî select a card ‚Äî</option>' +
    allCards.map(c =>
      `<option value="${c.id}">${c.setName} ¬∑ #${c.number}</option>`
    ).join('');
  cardSelect.disabled = false;

  const tierMsg = tier === 1 ? '' : tier === 2 ? ' (via backup API)' : ' (limited data)';
  showStatus(`Found ${allCards.length} card${allCards.length !== 1 ? 's' : ''}${tierMsg} ‚úì`, 'success');
  setTimeout(() => document.getElementById('statusMsg').classList.remove('show'), 3000);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  CARD SELECT ‚Üí show preview
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('cardSelect').addEventListener('change', e => {
  const id = e.target.value;
  if (!id) { resetPreview(); document.getElementById('pushBtn').disabled = true; return; }

  selectedCard = allCards.find(c => c.id === id);
  if (!selectedCard) return;

  const preview = document.getElementById('cardPreview');
  preview.classList.add('has-card');

  const imgHtml = selectedCard.imageSmall
    ? `<img class="card-thumb" src="${selectedCard.imageSmall}" alt="${selectedCard.name}" loading="lazy" onerror="this.style.opacity='0.3'">`
    : `<div class="card-thumb-placeholder">üÉè</div>`;

  preview.innerHTML = `
    ${imgHtml}
    <div class="card-info">
      <div class="card-name">${selectedCard.name}</div>
      <div class="card-set">${selectedCard.setName}</div>
      <div class="card-number">#${selectedCard.number}</div>
    </div>
  `;
  document.getElementById('pushBtn').disabled = false;
});

function resetPreview() {
  const preview = document.getElementById('cardPreview');
  preview.classList.remove('has-card');
  preview.innerHTML = `
    <div class="card-thumb-placeholder">üÉè</div>
    <div class="card-info">
      <div class="card-name" style="color:var(--muted)">No card selected</div>
      <div class="card-set">Select a Pok√©mon and card above</div>
    </div>
  `;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  PUSH TO FIREBASE  (credentials baked in)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('pushBtn').addEventListener('click', async () => {
  if (!selectedCard) return;

  const btn = document.getElementById('pushBtn');
  btn.disabled = true;
  btn.classList.add('sending');
  btn.textContent = '‚è≥ SENDING...';
  showStatus('Pushing to display‚Ä¶', 'loading', true);

  // Ripple effect
  const rect   = btn.getBoundingClientRect();
  const ripple = document.createElement('span');
  ripple.className = 'btn-ripple';
  ripple.style.cssText = `width:${rect.width}px;height:${rect.width}px;left:0;top:${(rect.height - rect.width) / 2}px`;
  btn.appendChild(ripple);
  setTimeout(() => ripple.remove(), 600);

  try {
    await setDoc(doc(db, 'display', 'current'), {
      cardId:     selectedCard.id,
      cardName:   selectedCard.name,
      setName:    selectedCard.setName,
      imageUrl:   selectedCard.imageUrl,
      imageSmall: selectedCard.imageSmall,
      pokemon:    selectedPokemon,
      number:     selectedCard.number,
      pushedAt:   new Date().toISOString(),
    });

    showStatus(`‚ö° "${selectedCard.name}" sent to your display!`, 'success');
    btn.textContent = '‚úì PUSHED!';
    setTimeout(() => {
      btn.textContent = '‚ñ∂ PUSH TO DISPLAY';
      btn.disabled = false;
      btn.classList.remove('sending');
    }, 2500);

  } catch(err) {
    console.error(err);
    showStatus('Firebase error: ' + err.message, 'error');
    btn.textContent = '‚ñ∂ PUSH TO DISPLAY';
    btn.disabled = false;
    btn.classList.remove('sending');
  }
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  HELPERS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function capitalize(s) {
  return s.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join('-');
}

function showStatus(msg, type, spinner = false) {
  const el = document.getElementById('statusMsg');
  el.className = `status show ${type}`;
  el.innerHTML = spinner
    ? `<div class="spinner"></div><span>${msg}</span>`
    : `<span>${msg}</span>`;
}
</script>
</body>
</html>
